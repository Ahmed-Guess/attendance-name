<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Check-in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0 15px -5px rgba(0, 0, 0, 0.04); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #lectureCodeDisplay a { text-decoration: none; color: inherit; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="card bg-white p-6 sm:p-8 rounded-xl w-full max-w-md">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Lecture Attendance Check-in</h1>
        <p class="text-gray-500 mb-6">Scan your unique QR code to verify your location and record attendance.</p>

        <form id="attendanceForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Current Lecture Code (Confirmed)</label>
                <p id="lectureCodeDisplay" class="font-bold text-lg text-blue-600 border p-3 rounded-lg bg-blue-50">
                    -- Loading Code --
                </p>
                <input type="hidden" id="lectureCodeHidden" name="lectureCode" value="">
                <input type="hidden" id="deviceTokenHidden" name="deviceToken" value="">
                <p class="text-xs text-gray-500 mt-1">This code identifies the class session and is set by the QR code.</p>
            </div>
            
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">School Email Address</label>
                <input type="email" id="email" name="email" required placeholder="your.name@school.edu"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
            </div>
            
            <button type="submit" id="submitButton" disabled
                    class="w-full flex justify-center items-center px-4 py-2 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-blue-400 cursor-not-allowed transition duration-150 ease-in-out disabled:opacity-60 disabled:cursor-not-allowed"
                    >
                <span id="buttonText">Waiting for Location Data...</span>
                <div id="loadingSpinner" class="spinner ml-2 hidden"></div>
            </button>
        </form>

        <div id="messageContainer" class="mt-6 p-4 rounded-lg text-sm hidden" role="alert"></div>
    </div>

    <script>
        // ======================================================================
        // CRITICAL CONSTANTS (Secured)
        // ======================================================================
        
        // 1. CLASSROOM LOCATION: Coordinates are now fetched from the Apps Script backend.
        let classroomCoordinates = null;
        
        // 2. MAX_DISTANCE_METERS REMOVED: The value is now private to the Code.gs backend.
        
        // 3. GOOGLE APPS SCRIPT WEB APP URL
        const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbySzYNWLbyGJk6t8h29yF9eGp4KQveLLzIAcDJPddHgvJJ2IT16vUsVDOhlX_7aR41ZFg/exec";
        
        // ======================================================================
        // Device Token Logic (UNCHANGED)
        // ======================================================================
        const DEVICE_TOKEN_KEY = 'attendance_device_token';

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function getOrCreateDeviceToken() {
            let token = localStorage.getItem(DEVICE_TOKEN_KEY);
            if (!token) {
                token = generateUUID();
                localStorage.setItem(DEVICE_TOKEN_KEY, token);
                console.log("New Device Token created and saved:", token);
            } else {
                console.log("Existing Device Token loaded:", token);
            }
            return token;
        }
        
        // ======================================================================
        // DOM ELEMENTS AND UTILITIES (UNCHANGED)
        // ======================================================================
        const form = document.getElementById('attendanceForm');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const messageContainer = document.getElementById('messageContainer');
        const lectureCodeDisplay = document.getElementById('lectureCodeDisplay');
        const lectureCodeHidden = document.getElementById('lectureCodeHidden');
        const deviceTokenHidden = document.getElementById('deviceTokenHidden');

        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const phi1 = lat1 * Math.PI / 180;
            const phi2 = lat2 * Math.PI / 180;
            const deltaPhi = (lat2 - lat1) * Math.PI / 180;
            const deltaLambda = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                      Math.cos(phi1) * Math.cos(phi2) *
                      Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; 
        }

        function setMessage(message, type = 'info') {
            messageContainer.textContent = message;
            messageContainer.className = 'mt-6 p-4 rounded-lg text-sm';
            messageContainer.classList.remove('hidden');

            messageContainer.classList.remove('bg-green-100', 'text-green-800', 'border-green-400', 
                                             'bg-red-100', 'text-red-800', 'border-red-400', 
                                             'bg-blue-100', 'text-blue-800', 'border-blue-400');

            if (type === 'success') {
                messageContainer.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-400');
            } else if (type === 'error') {
                messageContainer.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-400');
            } else {
                messageContainer.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-400');
            }
        }

        function setSubmitting(isSubmitting) {
            submitButton.disabled = isSubmitting;
            loadingSpinner.classList.toggle('hidden', !isSubmitting);
            submitButton.classList.toggle('bg-blue-600', !isSubmitting);
            submitButton.classList.toggle('hover:bg-blue-700', !isSubmitting);
            
            if (isSubmitting) {
                buttonText.textContent = 'Verifying Location...';
            } else if (lectureCodeHidden.value && classroomCoordinates) {
                buttonText.textContent = 'Check Location & Submit Attendance';
            } else if (lectureCodeHidden.value && !classroomCoordinates) {
                 buttonText.textContent = 'Loading Location Data...';
            } else {
                buttonText.textContent = 'Waiting for Lecture Code...';
                submitButton.classList.add('bg-blue-400'); 
            }
        }

        // ======================================================================
        // MODIFIED: FUNCTION TO SECURELY FETCH COORDINATES
        // ======================================================================
        async function fetchClassroomCoordinates() {
            try {
                // Fetch using the APPS_SCRIPT_WEB_APP_URL, which will hit the doGet function
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL);
                
                if (!response.ok) throw new Error("Failed to fetch coordinates from server.");
                
                const data = await response.json();
                
                // Check for coordinate keys in the response
                if (typeof data.latitude !== 'number' || typeof data.longitude !== 'number') {
                     throw new Error("Invalid coordinate format received from server. Check your Code.gs getConstants/doGet return keys.");
                }
                
                // Save the fetched coordinates globally
                // The keys here must match what your Code.gs returns (latitude/longitude)
                classroomCoordinates = data; 
                console.log("Classroom coordinates successfully loaded from server.");
                
            } catch (error) {
                console.error("Coordinate Fetch Error:", error);
                setMessage("FATAL ERROR: Could not securely load classroom location data. Please ensure the Apps Script is deployed with the doGet function returning latitude and longitude.", 'error');
            }
        }
        
        // ======================================================================
        // MAIN LOGIC (MODIFIED TO REMOVE CLIENT-SIDE PROXIMITY CHECK)
        // ======================================================================
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 1. Pre-Submission Checks
            if (!classroomCoordinates) {
                setMessage("ERROR: Classroom coordinates not loaded yet. Please wait a moment and try again.", 'error');
                return;
            }

            const email = document.getElementById('email').value.trim();
            const lectureCode = lectureCodeHidden.value; 
            const deviceToken = deviceTokenHidden.value; 

            if (!lectureCode) {
                 setMessage("ERROR: Lecture code not found in the QR code URL. Cannot submit.", 'error');
                 return;
            }
            if (!deviceToken) {
                 setMessage("FATAL ERROR: Device token missing. Please try refreshing your browser.", 'error');
                 return;
            }
            
            setSubmitting(true);
            setMessage('Requesting your current location...', 'info');

            // 2. Get GPS Location
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLon = position.coords.longitude;
                        
                        // 3. Calculate Distance (for logging purposes only)
                        const distance = calculateDistance(
                            userLat, 
                            userLon, 
                            classroomCoordinates.latitude, 
                            classroomCoordinates.longitude
                        );

                        // *** CRITICAL SECURITY CHANGE: REMOVED client-side proximity check ***
                        // The server (Code.gs) will perform the secure check using MAX_DISTANCE_METERS.
                        
                        setMessage(`Calculated distance: ${distance.toFixed(1)} meters. Sending to server for final verification...`, 'info');
                        
                        // 4. Submit to Server
                        submitAttendance(email, lectureCode, userLat, userLon, deviceToken, distance);
                    },
                    (error) => {
                        setMessage(`Location Error: ${error.message}. Please enable location services and refresh the page.`, 'error');
                        setSubmitting(false);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                setMessage("Geolocation is not supported by your device or browser.", 'error');
                setSubmitting(false);
            }
        });

        // MODIFIED: Added distance parameter to be sent to the server for logging/check
        async function submitAttendance(email, lectureCode, lat, lon, deviceToken, distance) {
            const formData = new URLSearchParams();
            formData.append('email', email);
            formData.append('lectureCode', lectureCode);
            formData.append('userLat', lat);
            formData.append('userLon', lon);
            formData.append('deviceToken', deviceToken);
            // ADDITION: Send the calculated distance to the server for logging/check
            formData.append('distance', distance.toFixed(1)); 

            try {
                let response = null;
                const maxRetries = 3;
                let delay = 1000;

                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                            method: 'POST',
                            body: formData.toString(),
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            }
                        });

                        if (response.ok) break; 

                    } catch (fetchError) {
                        if (i === maxRetries - 1) throw fetchError;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    }
                }

                if (!response || !response.ok) throw new Error("Failed to get a successful response from the server.");

                const result = await response.json();

                if (result.status === 'success') {
                    setMessage(`Success! Your attendance has been recorded for lecture code: ${lectureCode}.`, 'success');
                    document.getElementById('email').value = '';
                } else {
                    // Rejection from the backend (e.g., too far, duplicate device, or closed code)
                    setMessage(`Submission failed (Server Check): ${result.message || 'An unknown error occurred on the server.'}`, 'error');
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                setMessage("Network Error: Could not connect to the attendance system after retries. Please check your connection.", 'error');
            } finally {
                setSubmitting(false);
            }
        }

        // MODIFIED window.onload (Now asynchronous to wait for coordinates)
        window.onload = async () => {
            // 1. Fetch coordinates first (asynchronously)
            await fetchClassroomCoordinates();

            // 2. CRITICAL ADDITION: Get or create the unique token and set the hidden field
            const token = getOrCreateDeviceToken();
            deviceTokenHidden.value = token;

            const lectureCode = getUrlParameter('code').toUpperCase(); 
            
            // 3. Update UI based on loaded data
            if (lectureCode) {
                lectureCodeDisplay.textContent = lectureCode;
                lectureCodeHidden.value = lectureCode;
                // Only enable the button if the lecture code AND coordinates are loaded
                submitButton.disabled = !classroomCoordinates; 
                submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                submitButton.classList.remove('bg-blue-400');
                buttonText.textContent = classroomCoordinates ? 'Check Location & Submit Attendance' : 'Loading Location Data...';
                setMessage('Lecture code detected. Enter your email to proceed.', 'info');
            } else {
                lectureCodeDisplay.textContent = "Error: Code Missing";
                lectureCodeDisplay.classList.remove('text-blue-600', 'bg-blue-50');
                lectureCodeDisplay.classList.add('text-red-600', 'bg-red-100');
                setMessage("ERROR: No lecture code found in the URL. Please ensure you scanned the correct QR code.", 'error');
            }
        };
    </script>
</body>
</html>





