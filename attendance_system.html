<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Check-in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0 15px -5px rgba(0, 0, 0, 0.04); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #lectureCodeDisplay a { text-decoration: none; color: inherit; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="card bg-white p-6 sm:p-8 rounded-xl w-full max-w-md">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Lecture Attendance Check-in</h1>
        <p class="text-gray-500 mb-6">Scan your unique QR code to verify your location and record attendance.</p>

        <form id="attendanceForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Current Lecture Code (Confirmed)</label>
                <p id="lectureCodeDisplay" class="font-bold text-lg text-blue-600 border p-3 rounded-lg bg-blue-50">
                    -- Loading Code --
                </p>
                <input type="hidden" id="lectureCodeHidden" name="lectureCode" value="">
                <input type="hidden" id="deviceTokenHidden" name="deviceToken" value="">
                <p class="text-xs text-gray-500 mt-1">This code identifies the class session and is set by the QR code.</p>
            </div>
            
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">School Email Address</label>
                <input type="email" id="email" name="email" required placeholder="your.name@school.edu"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
            </div>
            
            <button type="submit" id="submitButton" disabled
                    class="w-full flex justify-center items-center px-4 py-2 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-blue-400 cursor-not-allowed transition duration-150 ease-in-out disabled:opacity-60 disabled:cursor-not-allowed"
                    >
                <span id="buttonText">Waiting for Location Data...</span>
                <div id="loadingSpinner" class="spinner ml-2 hidden"></div>
            </button>
        </form>

        <div id="messageContainer" class="mt-6 p-4 rounded-lg text-sm hidden" role="alert"></div>
    </div>

    <script>
        // ======================================================================
        // 1. CONFIGURATION & CONSTANTS
        // ======================================================================
        
        let classroomCoordinates = null;
        const DEVICE_TOKEN_KEY = 'attendance_device_token';
        
        // UPDATE THIS URL with your deployed Google Apps Script Web App URL
        const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyHuOiqVdz3CfmB2WCRB_Q8Zpmjw7-Nxk_h6mC3W9bGzfSOotmKIt_KLN0MJYYIlz6rIw/exec";
        
        // ======================================================================
        // 2. DEVICE TRACKING LOGIC (Anti-Fraud)
        // ======================================================================

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        /**
         * Checks both localStorage and sessionStorage for a token.
         * If none exists, it generates one. This makes it harder for students
         * to "reset" their device ID by simply opening a new tab.
         */
        function getOrCreateDeviceToken() {
            let token = localStorage.getItem(DEVICE_TOKEN_KEY) || sessionStorage.getItem(DEVICE_TOKEN_KEY);
            
            if (!token) {
                token = generateUUID();
                console.log("New Device Token generated.");
            }
            
            // Re-sync both storages
            localStorage.setItem(DEVICE_TOKEN_KEY, token);
            sessionStorage.setItem(DEVICE_TOKEN_KEY, token);
            return token;
        }
        
        // ======================================================================
        // 3. UI & UTILITY FUNCTIONS
        // ======================================================================
        const form = document.getElementById('attendanceForm');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const messageContainer = document.getElementById('messageContainer');
        const lectureCodeDisplay = document.getElementById('lectureCodeDisplay');
        const lectureCodeHidden = document.getElementById('lectureCodeHidden');
        const deviceTokenHidden = document.getElementById('deviceTokenHidden');

        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        /**
         * Client-side distance calculation for UI feedback.
         * The official security check is still performed on the Backend.
         */
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; 
            const phi1 = lat1 * Math.PI / 180;
            const phi2 = lat2 * Math.PI / 180;
            const dPhi = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(dPhi / 2) * Math.sin(dPhi / 2) +
                      Math.cos(phi1) * Math.cos(phi2) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; 
        }

        function setMessage(message, type = 'info') {
            messageContainer.textContent = message;
            messageContainer.className = 'mt-6 p-4 rounded-lg text-sm border';
            messageContainer.classList.remove('hidden');

            if (type === 'success') {
                messageContainer.classList.add('bg-green-100', 'text-green-800', 'border-green-400');
            } else if (type === 'error') {
                messageContainer.classList.add('bg-red-100', 'text-red-800', 'border-red-400');
            } else {
                messageContainer.classList.add('bg-blue-100', 'text-blue-800', 'border-blue-400');
            }
        }

        function setSubmitting(isSubmitting) {
            submitButton.disabled = isSubmitting;
            loadingSpinner.classList.toggle('hidden', !isSubmitting);
            submitButton.classList.toggle('bg-blue-600', !isSubmitting);
            
            if (isSubmitting) {
                buttonText.textContent = 'Verifying Data...';
            } else {
                buttonText.textContent = 'Check Location & Submit Attendance';
            }
        }

        // ======================================================================
        // 4. DATA FETCHING & FORM SUBMISSION
        // ======================================================================

        async function fetchClassroomCoordinates() {
            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL);
                if (!response.ok) throw new Error("Server error.");
                const data = await response.json();
                if (typeof data.latitude === 'number') {
                    classroomCoordinates = data;
                }
            } catch (error) {
                console.error("Coordinate Fetch Error:", error);
                setMessage("ERROR: Could not load classroom location. Check Internet.", 'error');
            }
        }

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!classroomCoordinates) {
                setMessage("Location data not ready. Please wait.", 'error');
                return;
            }

            const email = document.getElementById('email').value.trim();
            const lectureCode = lectureCodeHidden.value; 
            const deviceToken = deviceTokenHidden.value; 
            
            setSubmitting(true);
            setMessage('Requesting GPS location...', 'info');

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLon = position.coords.longitude;
                        
                        // Calculate distance for the log (Server does the final validation)
                        const distance = calculateDistance(
                            userLat, userLon, 
                            classroomCoordinates.latitude, classroomCoordinates.longitude
                        );

                        submitAttendance(email, lectureCode, userLat, userLon, deviceToken, distance);
                    },
                    (error) => {
                        setMessage(`Location Error: ${error.message}. Please enable GPS.`, 'error');
                        setSubmitting(false);
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            } else {
                setMessage("Geolocation not supported.", 'error');
                setSubmitting(false);
            }
        });

        async function submitAttendance(email, lectureCode, lat, lon, deviceToken, distance) {
            const formData = new URLSearchParams();
            formData.append('email', email);
            formData.append('lectureCode', lectureCode);
            formData.append('userLat', lat);
            formData.append('userLon', lon);
            formData.append('deviceToken', deviceToken);
            formData.append('distance', distance.toFixed(1)); 

            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    body: formData.toString(),
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                });

                const result = await response.json();

                if (result.status === 'success') {
                    setMessage(`Success! Attendance recorded for ${lectureCode}.`, 'success');
                    document.getElementById('email').value = '';
                } else {
                    setMessage(`Failed: ${result.message}`, 'error');
                }
            } catch (error) {
                setMessage("Network Error. Please try again.", 'error');
            } finally {
                setSubmitting(false);
            }
        }

        // ======================================================================
        // 5. INITIALIZATION
        // ======================================================================
        window.onload = async () => {
            await fetchClassroomCoordinates();
            
            const token = getOrCreateDeviceToken();
            deviceTokenHidden.value = token;

            const lectureCode = getUrlParameter('code').toUpperCase(); 
            
            if (lectureCode) {
                lectureCodeDisplay.textContent = lectureCode;
                lectureCodeHidden.value = lectureCode;
                submitButton.disabled = !classroomCoordinates; 
                submitButton.classList.add('bg-blue-600');
                submitButton.classList.remove('bg-blue-400');
                buttonText.textContent = classroomCoordinates ? 'Check Location & Submit Attendance' : 'Loading...';
            } else {
                lectureCodeDisplay.textContent = "Error: Code Missing";
                setMessage("Scan the QR code again.", 'error');
            }
        };
    </script>
</body>
</html>
